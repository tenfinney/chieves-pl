{"version":3,"file":"disburse.01369bf5.js","sources":["../../src/pages/disburse.tsx"],"sourcesContent":["import React, {\n  ChangeEvent, FormEvent, ReactNode, useCallback,\n  useEffect, useMemo, useState,\n} from 'react'\nimport {\n  Alert, AlertDescription, AlertIcon, AlertTitle, Box,\n  Button, Container, Tabs, TabList, Tab,\n  TabPanels, TabPanel, FormControl, FormLabel, Textarea,\n  OrderedList, ListItem, Stack, Text, Flex, Spinner,\n  Checkbox, RadioGroup, Radio, useToast,\n} from '@chakra-ui/react'\nimport { capitalize, deregexify, extractMessage, httpURL } from '@/lib/helpers'\nimport { Maybe, ERC1155Metadata, Optional } from '@/lib/types'\nimport { useWeb3 } from '@/lib/hooks'\nimport { HomeLink } from '@/components'\nimport { useParams } from 'react-router-dom'\nimport { Helmet } from 'react-helmet'\n\nconst Address: React.FC<{ name: string }> = ({ name }) => {\n  const { ensProvider } = useWeb3()\n  const isAddress = useMemo(\n    () => /^0x[a-z0-9]{40}$/i.test(name),\n    [name],\n  )\n  const [address, setAddress] = useState<Optional<Maybe<string>>>(\n    isAddress ? undefined : null\n  )\n  useMemo(\n    () => {\n      if(!isAddress) {\n        const resolve = async () => {\n          const resolved = await ensProvider?.resolveName(name)\n          setAddress(resolved ?? 'Not Found')\n        }\n        resolve()\n      }\n    },\n    [isAddress, ensProvider, name],\n  )\n\n  return (\n    <>\n      <Text>\n        {name}\n        {address != null && (\n          <Text ml={2} as=\"em\">({address})</Text>\n        )}\n      </Text>\n      {address === null && <Spinner size=\"xs\"/>}\n    </>\n  )\n}\n\nconst split = (raw: string) => (\n  raw.split(/\\s*[\\s,;:/\\\\|]+\\s*/)\n  .filter((str: string) => str && str !== '')\n)\n\nconst Disburse = () => {\n  const { nftId } = useParams() \n  const tokenId = useMemo(() => (\n    deregexify(Array.isArray(nftId) ? nftId[0] : nftId)\n  ), [nftId])\n  const [balance, setBalance] = useState<number>()\n  const [metadata, setMetadata] = (\n    useState<Maybe<ERC1155Metadata>>()\n  )\n  const [error, setError] = useState<string>()\n  const [raw, setRaw] = useState('')\n  const [action, setAction] = useState('whitelist')\n  const {\n    ensProvider, address, roContract, rwContract, connect,\n  } = useWeb3()\n  const [addresses, setAddresses] = useState<Array<string | ReactNode>>([])\n  const toast = useToast()\n\n  useEffect(() => {\n    const parse = async () => {\n      setAddresses(\n        split(raw)\n        .map((name: string, idx: number) => (\n          <Address key={idx} {...{ name }}/>\n        ))\n      )\n    }\n\n    parse()\n  }, [ensProvider, raw])\n\n  const name = useMemo(\n    () => metadata?.name ?? `#${tokenId}`,\n    [metadata, tokenId],\n  )\n\n  useEffect(() => {\n    const getBalance = async () => {\n      if(roContract && address && tokenId) {\n        try {\n          setBalance(Number(\n            (await roContract.balanceOf(address, tokenId)).toString()\n          ))\n        } catch(err) {\n          setError((err as Error).message)\n        }\n      }\n    }\n    \n    getBalance()\n  }, [address, roContract, tokenId])\n  \n  useEffect(\n    () => {\n      const getMetadata = async () => {\n        if(roContract && tokenId) {\n          try {\n            const meta = await roContract.uri(tokenId)\n            if(!meta) {\n              setMetadata(null)\n            } else {\n              const response = await fetch(httpURL(meta)!)\n              setMetadata(await response.json())\n            }\n          } catch(err) {\n            setError((err as Error).message)\n          }\n        }\n      }\n\n      getMetadata()\n    },\n    [roContract, tokenId],\n  )\n\n  const submit = useCallback(async (evt: FormEvent) => {\n    evt.preventDefault()\n\n    if(!rwContract) {\n      toast({\n        title: 'Contract Error!',\n        description: 'Token is not Connected.',\n        status: 'error',\n        isClosable: true,\n        duration: 10000\n      })\n      return\n    }\n    try {\n      // const skip = evt.target.skip.checked\n      const addrs = await Promise.all(\n        split(raw)\n        .map(async (name: string) => {\n          const response = await ensProvider?.resolveName(name)\n          if(!response) {\n            throw new Error(`Couldn't Resolve Name: “${name}”`)\n          }\n          return response\n        })\n      )\n      switch(action) {\n        case 'mint': {\n          const tx = await rwContract?.['mint(address[],uint256,bytes)'](\n            addrs, tokenId, []\n          )\n          await tx.wait()\n          break\n        }\n        case 'whitelist': {\n          console.debug('whitelist', { addrs })\n          addrs.map(async (addr) => {\n            const minterRole = await roContract?.roleIndexForName('Minter')\n            const tx = await rwContract?.['mint(address,uint256,uint256,bytes)'](\n              addr, tokenId, 1, []\n            )\n          })\n          break\n        }\n      }\n    } catch(err) {\n      toast({\n        title: `${capitalize(action)}ing Error`,\n        description: extractMessage(err),\n        status: 'error',\n        isClosable: true,\n        duration: 10000\n      })\n    }\n  }, [action, ensProvider, raw, roContract, rwContract, toast, tokenId])\n\n  if(error) {\n    return (\n      <Alert status=\"error\">\n        <AlertIcon />\n        <AlertTitle mr={2}>Error: Loading NFT</AlertTitle>\n        <AlertDescription>{error}</AlertDescription>\n      </Alert>\n    )\n  }\n\n  return (\n    <Container maxW=\"40rem\">\n      <Helmet>\n        <title>Disburse NFT #{tokenId}</title>\n        <meta name=\"description\" content=\"Distribute a Token or Digital Asset\" />\n      </Helmet>\n\n      <HomeLink/>\n\n      <Stack as=\"form\" onSubmit={submit}>\n        {(() => {\n          if(metadata === null) {\n            return <Text my={8}>Token {name} does not exist.</Text>\n          } else if(!address) {\n            return (\n              <Text my={8}>\n                Connect your wallet to distribute “{name}” tokens…\n              </Text>\n            )\n          } else if(balance == null) {\n            return (\n              <Flex my={8}>\n                <Spinner/>\n                <Text ml={2}>Loading Balance…</Text>\n              </Flex>\n            )\n          } else {\n            return <Text my={8}>Distribute up to {balance} “{name}” tokens:</Text>\n          }\n        })()}\n        <Tabs isFitted variant=\"enclosed\">\n          <TabList mb=\"1em\">\n            <Tab>CSV</Tab>\n            <Tab>Parsed</Tab>\n          </TabList>\n          <TabPanels>\n            <TabPanel>\n              <FormControl>\n                <FormLabel>Comma, Space, or Semicolon Separated ETH or ENS Addresses:</FormLabel>\n                <Textarea\n                  height={64}\n                  placeholder=\"Enter space, semicolon, or comma separated eth addresses.\"\n                  value={raw}\n                  onChange={\n                    ({ target: { value } }: ChangeEvent<HTMLTextAreaElement>) => {\n                      setRaw(value)\n                    }\n                  }\n                />\n              </FormControl>\n            </TabPanel>\n            <TabPanel>\n              <OrderedList>\n                {addresses.map((addr, idx) => (\n                  <ListItem key={idx} justifyContent=\"center\">\n                    {addr}\n                  </ListItem>\n                ))}\n              </OrderedList>\n            </TabPanel>\n          </TabPanels>\n        </Tabs>\n        <FormControl>\n          <RadioGroup onChange={setAction} value={action}>\n            <Radio value=\"mint\">Mint</Radio>\n            <Radio value=\"whitelist\" ml={5}>Whitelist</Radio>\n          </RadioGroup>\n        </FormControl>\n        <FormControl>\n          <Checkbox name=\"skip\" value=\"true\">\n            Skip existing holders\n          </Checkbox>\n        </FormControl>\n        <FormControl textAlign=\"center\">\n          {!rwContract ? (\n            <Button onClick={connect}>\n              Connect\n            </Button>\n          ) : (\n            <Button type=\"submit\" colorScheme=\"green\">Distribute</Button>\n          )}\n        </FormControl>\n      </Stack>\n    </Container>\n  )\n}\n\nexport default Disburse"],"names":["Address","name","ensProvider","useWeb3","isAddress","useMemo","test","address","setAddress","useState","undefined","resolve","resolved","resolveName","_Fragment","_jsxs","split","raw","filter","str","Disburse","nftId","useParams","tokenId","deregexify","Array","isArray","balance","setBalance","metadata","setMetadata","error","setError","setRaw","action","setAction","roContract","rwContract","connect","addresses","setAddresses","toast","useToast","useEffect","parse","map","idx","getBalance","Number","balanceOf","toString","err","message","getMetadata","meta","uri","response","fetch","httpURL","json","submit","useCallback","evt","preventDefault","title","description","status","isClosable","duration","addrs","Promise","all","Error","tx","wait","console","debug","addr","minterRole","roleIndexForName","capitalize","extractMessage","_jsx","Helmet","target","value"],"mappings":"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"}